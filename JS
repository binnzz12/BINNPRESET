let currentImageUrl = "";

// Isi input dari tag
function fillInput(text) {
    document.getElementById("textInput").value = text;
}

// Generate gambar
function generateImage() {
    const input = document.getElementById("textInput");
    const btnGenerate = document.getElementById("generateBtn");
    const btnDownload = document.getElementById("downloadBtn");
    const img = document.getElementById("resultImage");
    const loader = document.getElementById("loader");
    const placeholder = document.getElementById("placeholder");
    const container = document.getElementById("resultContainer");

    const text = input.value.trim();
    if (!text) {
        input.focus();
        return;
    }

    // UI loading
    btnGenerate.disabled = true;
    btnGenerate.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> CREATING...';
    btnDownload.style.display = "none";
    img.style.display = "none";
    placeholder.style.display = "none";
    loader.style.display = "block";
    container.classList.remove("active");

    const apiUrl = `https://api.ryzumi.vip/api/image/iqc?text=${encodeURIComponent(text)}`;

    const tempImg = new Image();
    tempImg.crossOrigin = "Anonymous";
    tempImg.src = apiUrl;

    tempImg.onload = () => {
        img.src = apiUrl;
        currentImageUrl = apiUrl;

        loader.style.display = "none";
        img.style.display = "block";
        container.classList.add("active");

        btnGenerate.disabled = false;
        btnGenerate.innerHTML = '<i class="fas fa-sync"></i> RE-GENERATE';
        btnDownload.style.display = "flex";
    };

    tempImg.onerror = () => {
        loader.style.display = "none";
        placeholder.style.display = "block";
        placeholder.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <p style="color:#ef4444">Connection Failed</p>
        `;

        btnGenerate.disabled = false;
        btnGenerate.innerHTML = '<i class="fas fa-redo"></i> RETRY';
    };
}

// Download gambar
async function downloadImage() {
    if (!currentImageUrl) return;

    const btn = document.getElementById("downloadBtn");
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';

    try {
        const response = await fetch(currentImageUrl);
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `IQC_IMAGE_${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();

        URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch {
        window.open(currentImageUrl, "_blank");
    } finally {
        btn.innerHTML = originalText;
    }
}

// Enter untuk generate
document.getElementById("textInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        generateImage();
    }
});
